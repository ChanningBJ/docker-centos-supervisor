machine:
  services:
    - docker

dependencies:
  override:
    # Build Centos version
    - RELEASE=$(grep "SUPERVISOR_VERSION=" Dockerfile | sed 's|^.*=||g' |awk '{print $1}'); docker build -t million12/centos-supervisor:$RELEASE centos/
    - docker build -t million12/centos-supervisor:latest centos/
    # Build Alpine Version
    - echo "TBA"

# Run tests
test:
  override:
    - docker run -d --name centos million12/centos-supervisor:latest && sleep 5 
    # Test if supervisord is running
    - while true; do if docker logs centos | grep "supervisord started with pid"; then break; else sleep 1; fi done
    # Test if supervisorctl is working
    - docker exec -ti centos bash -c "supervisorctl version"
    # Test if we have inotify working
    - docker exec -ti centos bash -c "inotifywatch -t 1 /home | tee /tmp/out"

deployment:
  production:
    branch:
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - RELEASE=$(grep "SUPERVISOR_VERSION=" Dockerfile | sed 's|^.*=||g' |awk '{print $1}'); docker push million12/centos-supervisor:$RELEASE
      - docker push million12/centos-supervisor:latest